!function(e,n){if("object"==typeof exports&&"object"==typeof module)module.exports=n();else if("function"==typeof define&&define.amd)define([],n);else{var t=n();for(var r in t)("object"==typeof exports?exports:e)[r]=t[r]}}(window,function(){return function(e){var n={};function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)t.d(r,o,function(n){return e[n]}.bind(null,o));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=0)}([function(e,n,t){"use strict";t.r(n);function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var o=function(e){var n,t=new ArrayBuffer(256),o=new DataView(t),i=0,u=function(e){for(var r=t.byteLength,u=i+e;r<u;)r<<=1;if(r!==t.byteLength){var s=o;t=new ArrayBuffer(r),o=new DataView(t);for(var c=i+3>>2,a=0;a<c;++a)o.setUint32(a<<2,s.getUint32(a<<2))}return n=e,o},s=function(){i+=n},c=function(e){s(u(1).setUint8(i,e))},a=function(e){for(var n=u(e.length),t=0;t<e.length;++t)n.setUint8(i+t,e[t]);s()},l=function(e,n){var t;n<24?c(e<<5|n):n<256?(c(e<<5|24),c(n)):n<65536?(c(e<<5|25),t=n,s(u(2).setUint16(i,t))):n<4294967296?(c(e<<5|26),function(e){s(u(4).setUint32(i,e))}(n)):(c(e<<5|27),function(e){var n=e%4294967296,t=(e-n)/4294967296,r=u(8);r.setUint32(i,t),r.setUint32(i+4,n),s()}(n))};if(function e(n){var t;if(!1===n)return c(244);if(!0===n)return c(245);if(null===n)return c(246);if(void 0===n)return c(247);switch(r(n)){case"number":if(Math.floor(n)===n){if(0<=n&&n<=9007199254740992)return l(0,n);if(-9007199254740992<=n&&n<0)return l(1,-(n+1))}return c(251),function(e){s(u(8).setFloat64(i,e))}(n);case"string":var o=[];for(t=0;t<n.length;++t){var f=n.charCodeAt(t);f<128?o.push(f):f<2048?(o.push(192|f>>6),o.push(128|63&f)):f<55296?(o.push(224|f>>12),o.push(128|f>>6&63),o.push(128|63&f)):(f=(1023&f)<<10,f|=1023&n.charCodeAt(++t),f+=65536,o.push(240|f>>18),o.push(128|f>>12&63),o.push(128|f>>6&63),o.push(128|63&f))}return l(3,o.length),a(o);default:var h;if(Array.isArray(n))for(h=n.length,l(4,h),t=0;t<h;++t)e(n[t]);else if(n instanceof Uint8Array)l(2,n.length),a(n);else{var d=Object.keys(n);for(h=d.length,l(5,h),t=0;t<h;++t){var v=d[t];e(v),e(n[v])}}}}(e),"slice"in t)return t.slice(0,i);for(var f=new ArrayBuffer(i),h=new DataView(f),d=0;d<i;++d)h.setUint8(d,o.getUint8(d));return f},i=function(e,n,t){var r;r=e instanceof Uint8Array?new DataView(e.buffer,e.byteOffset,e.byteLength):new DataView(e);var o=0;"function"!=typeof n&&(n=function(e){return e}),"function"!=typeof t&&(t=function(){});var i=function(e,n){return o+=e,n},u=function(n){return i(n,new Uint8Array(e,o,n))},s=function(){return i(1,r.getUint8(o))},c=function(){return i(2,r.getUint16(o))},a=function(){return i(4,r.getUint32(o))},l=function(){return 255===r.getUint8(o)&&(o+=1,!0)},f=function(e){if(e<24)return e;if(24===e)return s();if(25===e)return c();if(26===e)return a();if(27===e)return 4294967296*a()+a();if(31===e)return-1;throw"Invalid length encoding"},h=function(e){var n=s();if(255===n)return-1;var t=f(31&n);if(t<0||n>>5!==e)throw"Invalid indefinite length element";return t},d=function(e,n){for(var t=0;t<n;++t){var r=s();0!=(128&r)&&(r<224?(r=(31&r)<<6|63&s(),n-=1):r<240?(r=(15&r)<<12|(63&s())<<6|63&s(),n-=2):(r=(15&r)<<18|(63&s())<<12|(63&s())<<6|63&s(),n-=3)),r<65536?e.push(r):(r-=65536,e.push(55296|r>>10),e.push(56320|1023&r))}},v=function e(){var a,v,y=s(),p=y>>5,m=31&y;if(7===p)switch(m){case 25:return function(){var e=new ArrayBuffer(4),n=new DataView(e),t=c(),r=32768&t,o=31744&t,i=1023&t;if(31744===o)o=261120;else if(0!==o)o+=114688;else if(0!==i)return(r?-1:1)*i*5.960464477539063e-8;return n.setUint32(0,r<<16|o<<13|i<<13),n.getFloat32(0)}();case 26:return i(4,r.getFloat32(o));case 27:return i(8,r.getFloat64(o))}if((v=f(m))<0&&(p<2||6<p))throw"Invalid length";switch(p){case 0:return v;case 1:return-1-v;case 2:if(v<0){for(var b=[],g=0;(v=h(p))>=0;)g+=v,b.push(u(v));var w=new Uint8Array(g),k=0;for(a=0;a<b.length;++a)w.set(b[a],k),k+=b[a].length;return w}return u(v);case 3:var j=[];if(v<0)for(;(v=h(p))>=0;)d(j,v);else d(j,v);return String.fromCharCode.apply(null,j);case 4:var C;if(v<0)for(C=[];!l();)C.push(e());else for(C=new Array(v),a=0;a<v;++a)C[a]=e();return C;case 5:var I={};for(a=0;a<v||v<0&&!l();++a)I[e()]=e();return I;case 6:return n(e(),v);case 7:switch(v){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:return t(v)}}}();if(o!==e.byteLength)throw"Remaining bytes";return v},u=new Error("connection lost");function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,n,t){return n&&c(e.prototype,n),t&&c(e,t),e}function l(e,n){return!n||"object"!==s(n)&&"function"!=typeof n?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):n}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function h(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&d(e,n)}function d(e,n){return(d=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e})(e,n)}function v(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var y=function e(n,t){v(this,e),this.client=n,this.consumerId=t},p=function(e){function n(e,t,r,o,i){var u;return v(this,n),(u=l(this,f(n).call(this,e,t))).pattern=r,u.options=i,u.handler=o,u}return h(n,y),a(n,[{key:"response",value:function(){return this}},{key:"handleRecords",value:function(e){var n=e.records,t=e.error;if(t)return this.handler({error:t}),!1;var r=n[0];if(0===r.length)return this.handler(null),!1;for(var o=0;o<r.length;o++)this.handler(r[o]);return!0}},{key:"handleDisconnect",value:function(){return this.handler({error:u}),!1}},{key:"handleReconnect",value:function(){return!1}}]),n}(),m=function(e){function n(e,t,r,o){var i;return v(this,n),(i=l(this,f(n).call(this,e,t))).key=r,i.options=o,i.resp=new Promise(function(e,n){i.resolve=function(n){e(n),i.resolve=null,i.reject=null},i.reject=function(e){n(e),i.resolve=null,i.reject=null}}),i}return h(n,y),a(n,[{key:"response",value:function(){return this.resp}},{key:"handleRecords",value:function(e){var n=e.recordIds,t=e.records,r=e.error;return r?(this.reject(r),!1):(this.resolve({recordId:n[0],payload:t[0]}),!1)}},{key:"handleDisconnect",value:function(){return!0}},{key:"handleReconnect",value:function(){return this.client.runLoadConsumer(this),!0}}]),n}(),b=function(e){function n(e,t){var r;return v(this,n),(r=l(this,f(n).call(this,e,t))).resp=new Promise(function(e,n){r.resolve=function(n){e(n),r.resolve=null,r.reject=null},r.reject=function(e){n(e),r.resolve=null,r.reject=null}}),r}return h(n,y),a(n,[{key:"response",value:function(){return this.resp}},{key:"handleRecords",value:function(e){var n=e.error;return n?(this.reject(n),!1):(this.resolve(),!1)}},{key:"handleDisconnect",value:function(){return this.reject(u),!1}},{key:"handleReconnect",value:function(){return!1}}]),n}(),g=function(e){function n(e,t,r,o,i,u){var s;return v(this,n),(s=l(this,f(n).call(this,e,t))).isContinuous=r,s.dql=o,s.handler=i,s.options=u,s}return h(n,y),a(n,[{key:"cancel",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.client.cancel(this,e)}},{key:"response",value:function(){return this}},{key:"handleRecords",value:function(e){var n=e.recordIds,t=e.records,r=e.error;if(r)return this.handler({error:r}),!1;if(!1===this.isContinuous&&0===t.length)return this.handler({record:null}),!1;for(var o=0;o<t.length;o++){var i=n[o];this.options.lastMessageId=i,this.handler({recordId:i,record:t[o]})}return!0}},{key:"handleDisconnect",value:function(){return!1!==this.isContinuous||(this.handler({error:u}),!1)}},{key:"handleReconnect",value:function(){return this.client.runQueryConsumer(this),!0}}]),n}();function w(e){return function(e){if(Array.isArray(e)){for(var n=0,t=new Array(e.length);n<e.length;n++)t[n]=e[n];return t}}(e)||C(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function k(e,n){return I(e)||function(e,n){var t=[],r=!0,o=!1,i=void 0;try{for(var u,s=e[Symbol.iterator]();!(r=(u=s.next()).done)&&(t.push(u.value),!n||t.length!==n);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(o)throw i}}return t}(e,n)||j()}function j(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function C(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function I(e){if(Array.isArray(e))return e}function O(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}t.d(n,"DrivelineClient",function(){return S});var S=function(){function e(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.options=Object.assign({},_,t,{endpoint:n}),this.consumers=new Map,this.consumerId=0,this.connectAttempts=0,this.connect()}var n,t,r;return n=e,r=[{key:"connect",value:function(n,t){return new e(n,t)}},{key:"displayStream",value:function(e,n,t,r,o){throw new Error("driveline-video extension is not loaded")}}],(t=[{key:"connect",value:function(){var e,n,t;this.ws=(n=(e=this).options.endpoint,(t=new WebSocket(n,"driveline")).binaryType="arraybuffer",t.addEventListener("open",function(n){return e.webSocketConnected()}),t.addEventListener("close",function(n){return e.webSocketDisconnected()}),t.addEventListener("error",function(n){return e.webSocketFailed()}),t.addEventListener("message",function(n){return e.webSocketReceivedMessage(n.data)}),t)}},{key:"sync",value:function(){var e=new b(this,this.consumerId++);return this.registerConsumer(e),this.ws_send("syn",e.consumerId),e.response()}},{key:"append",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};n=new Uint8Array(o(n)),t=Object.assign({},U,t);var r=M(t);this.ws_send("app",e,r,n)}},{key:"continuousQuery",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};t=Object.assign({},x,t);var r=new g(this,this.consumerId++,!0,e,n,t);return this.registerConsumer(r),this.runQueryConsumer(r)}},{key:"query",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};t=Object.assign({},x,t);var r=new g(this,this.consumerId++,!1,e,n,t);return this.registerConsumer(r),this.runQueryConsumer(r)}},{key:"cancel",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.unregisterConsumer(e)){n=Object.assign({},E,n);var t=T(n);this.ws_send("can",e.consumerId,t)}}},{key:"runQueryConsumer",value:function(e){var n=V(e.options),t=e.isContinuous?"sq":"qq";return this.ws_send(t,e.consumerId,n,e.dql),e.response()}},{key:"truncate",value:function(e){this.ws_send("trc",void 0,e)}},{key:"load",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n=Object.assign({},L,n);var t=new m(this,this.consumerId++,e,n);return this.registerConsumer(t),this.runLoadConsumer(t)}},{key:"runLoadConsumer",value:function(e){var n=F(e.options);return this.ws_send("ld",e.consumerId,n,e.key),e.response()}},{key:"store",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};n=new Uint8Array(o(n)),t=Object.assign({},P,t);var r=B(t);this.ws_send("st",e,r,n)}},{key:"remove",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n=Object.assign({},D,n);var t=Q(n);this.ws_send("rm",t,e)}},{key:"removeMatches",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n=Object.assign({},D,n);var t=Q(n);this.ws_send("rmk",t,e)}},{key:"listKeys",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};t=Object.assign({},R,t);var r=new p(this,this.consumerId++,e,n,t);return this.registerConsumer(r),this.runListConsumer("lst",r)}},{key:"listStreams",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};t=Object.assign({},R,t);var r=new p(this,this.consumerId++,e,n,t);return this.registerConsumer(r),this.runListConsumer("sls",r)}},{key:"displayStream",value:function(n,t,r,o){return e.displayStream(this,n,t,r,o)}},{key:"runListConsumer",value:function(e,n){var t=q(n.options);return this.ws_send(e,n.consumerId,t,n.pattern),n.response()}},{key:"registerConsumer",value:function(e){this.consumers.set(e.consumerId,e)}},{key:"unregisterConsumer",value:function(e){return this.consumers.delete(e.consumerId)}},{key:"ws_send",value:function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];var r=o(n);this.ws.send(r)}},{key:"webSocketConnected",value:function(){var e;this.connectAttempts=0;var n=[];this.consumers.forEach(function(e,t){e.handleReconnect()||n.push(t)}),n.forEach((e=this.consumers).delete.bind(e)),this.options.onConnected&&(this.options.onConnected(this),this.options.onConnected=null)}},{key:"webSocketDisconnected",value:function(){var e,n=[];this.consumers.forEach(function(e,t){e.handleDisconnect()||n.push(t)}),n.forEach((e=this.consumers).delete.bind(e))}},{key:"webSocketReceivedMessage",value:function(e){var n,t=i(e),r=null;switch(t[0]){case"data":var o=I(n=t)||C(n)||j(),u=o[1],s=o[2],c=o.slice(3);r={consumerId:u,recordIds:A(s||[]).recordIds,records:c.map(function(e){return e?i(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)):null})};break;case"syn":r={consumerId:k(t,2)[1],records:[],recordIds:[]};break;case"err":var a=k(t,3);r={consumerId:a[1],error:a[2]};break;default:return void console.error("unknown message received from server:",t)}if(this.consumers.has(r.consumerId)){var l=this.consumers.get(r.consumerId);l.handleRecords(r)||this.unregisterConsumer(l)}}},{key:"webSocketFailed",value:function(){if(this.connectAttempts+=1,this.connectAttempts>=this.options.maxReconnect)this.options.onError&&this.options.onError(u);else{var e=500*(2^this.connectAttempts-1)/2;setTimeout(this.connect.bind(this),e)}}}])&&O(n.prototype,t),r&&O(n,r),e}(),A=function(e){for(var n=[],t=0;t<e.length;t+=2)1===e[t]&&n.push.apply(n,w(e[t+1]));return{recordIds:n}},_={maxReconnect:10,onConnected:function(e){},onError:function(e){}},U={},E={},R={},L={},x={},D={},P={},M=function(){return null},T=function(){return null},q=function(){return null},F=function(){return null},V=function(e){var n=e.lastMessageId,t=[];return n&&t.push(2,n),t.length>0?t:null},Q=function(){return null},B=function(e){var n=e.ttl,t=e.casId,r=[];return n&&r.push(4,n),t&&r.push(3,t),r.length>0?r:null}}])});
